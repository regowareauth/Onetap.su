--[[ 
    Onyx UI Library - Internal/Clean Style
    Optimized for Loadstrings
]]

local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")

local Library = {}

--// THEME CONFIGURATION \\--
Library.Theme = {
    Main        = Color3.fromRGB(20, 20, 20),
    Sidebar     = Color3.fromRGB(15, 15, 15),
    Section     = Color3.fromRGB(25, 25, 25),
    Outline     = Color3.fromRGB(45, 45, 45),
    Accent      = Color3.fromRGB(0, 140, 255), -- Default Blue
    Text        = Color3.fromRGB(220, 220, 220),
    TextDim     = Color3.fromRGB(120, 120, 120),
}

--// UTILITIES \\--
local function Create(class, properties)
    local instance = Instance.new(class)
    for k, v in pairs(properties) do
        instance[k] = v
    end
    return instance
end

local function Tween(obj, props, time)
    local info = TweenInfo.new(time or 0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    TweenService:Create(obj, info, props):Play()
end

--// GUI INITIALIZATION \\--
function Library:Init(windowName)
    local Screen = Create("ScreenGui", {
        Name = windowName,
        ResetOnSpawn = false,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    })

    -- Protect GUI
    if pcall(function() Screen.Parent = CoreGui end) then
    else Screen.Parent = Players.LocalPlayer:WaitForChild("PlayerGui") end

    local Window = {}
    
    --// NOTIFICATION SYSTEM \\--
    function Window:Notify(title, msg, duration)
        local Toast = Create("Frame", {
            Parent = Screen,
            BackgroundColor3 = Library.Theme.Section,
            Position = UDim2.new(0, 20, 0, -100),
            Size = UDim2.new(0, 260, 0, 65),
            BorderSizePixel = 0,
            ZIndex = 100
        })
        
        Create("UICorner", {Parent = Toast, CornerRadius = UDim.new(0, 5)})
        Create("UIStroke", {Parent = Toast, Color = Library.Theme.Outline, Thickness = 1})
        
        -- Accent Line
        Create("Frame", {
            Parent = Toast,
            BackgroundColor3 = Library.Theme.Accent,
            Position = UDim2.new(0, 0, 0, 10),
            Size = UDim2.new(0, 3, 0, 45),
            BorderSizePixel = 0
        })

        local TTitle = Create("TextLabel", {
            Parent = Toast,
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 15, 0, 8),
            Size = UDim2.new(1, -20, 0, 20),
            Font = Enum.Font.GothamBold,
            Text = title:upper(),
            TextColor3 = Library.Theme.Accent,
            TextSize = 12,
            TextXAlignment = Enum.TextXAlignment.Left
        })

        Create("TextLabel", {
            Parent = Toast,
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 15, 0, 28),
            Size = UDim2.new(1, -20, 0, 30),
            Font = Enum.Font.Gotham,
            Text = msg,
            TextColor3 = Library.Theme.Text,
            TextSize = 12,
            TextWrapped = true,
            TextXAlignment = Enum.TextXAlignment.Left
        })

        Tween(Toast, {Position = UDim2.new(0, 20, 0, 20)})
        
        task.delay(duration or 3, function()
            Tween(Toast, {Position = UDim2.new(0, -300, 0, 20)})
            task.wait(0.5)
            Toast:Destroy()
        end)
    end

    --// MAIN FRAME \\--
    local Main = Create("Frame", {
        Name = "Main",
        Parent = Screen,
        BackgroundColor3 = Library.Theme.Main,
        Position = UDim2.new(0.5, -325, 0.5, -225),
        Size = UDim2.new(0, 650, 0, 450),
        ClipsDescendants = true
    })
    
    Create("UICorner", {Parent = Main, CornerRadius = UDim.new(0, 6)})
    Create("UIStroke", {Parent = Main, Color = Library.Theme.Outline, Thickness = 1})

    -- Dragging
    local dragging, dragInput, dragStart, startPos
    Main.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true; dragStart = input.Position; startPos = Main.Position
        end
    end)
    Main.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            Main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
    end)

    --// SIDEBAR \\--
    local Sidebar = Create("Frame", {
        Parent = Main,
        BackgroundColor3 = Library.Theme.Sidebar,
        Size = UDim2.new(0, 60, 1, 0),
        BorderSizePixel = 0
    })
    Create("UICorner", {Parent = Sidebar, CornerRadius = UDim.new(0, 6)})
    -- Square off right side
    Create("Frame", {Parent = Sidebar, BackgroundColor3 = Library.Theme.Sidebar, Size = UDim2.new(0, 10, 1, 0), Position = UDim2.new(1, -10, 0, 0), BorderSizePixel = 0})

    local TabHolder = Create("UIListLayout", {
        Parent = Sidebar,
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        Padding = UDim.new(0, 15),
        SortOrder = Enum.SortOrder.LayoutOrder
    })
    Create("UIPadding", {Parent = Sidebar, PaddingTop = UDim.new(0, 20)})

    --// CONTENT AREA \\--
    local Content = Create("Frame", {
        Parent = Main,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 70, 0, 10),
        Size = UDim2.new(1, -80, 1, -20)
    })

    local Tabs = {}
    local FirstTab = true

    --// TAB CREATION \\--
    function Window:Tab(iconId)
        local Tab = {}
        
        local TabBtn = Create("ImageButton", {
            Parent = Sidebar,
            BackgroundTransparency = 1,
            Size = UDim2.new(0, 24, 0, 24),
            Image = "rbxassetid://" .. iconId,
            ImageColor3 = Library.Theme.TextDim
        })

        local Page = Create("ScrollingFrame", {
            Parent = Content,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 1, 0),
            ScrollBarThickness = 0,
            Visible = false
        })

        -- Column Layout
        local LeftCol = Create("Frame", {Parent = Page, BackgroundTransparency = 1, Size = UDim2.new(0.48, 0, 1, 0)})
        local RightCol = Create("Frame", {Parent = Page, BackgroundTransparency = 1, Size = UDim2.new(0.48, 0, 1, 0), Position = UDim2.new(0.52, 0, 0, 0)})
        
        Create("UIListLayout", {Parent = LeftCol, Padding = UDim.new(0, 10), SortOrder = Enum.SortOrder.LayoutOrder})
        Create("UIListLayout", {Parent = RightCol, Padding = UDim.new(0, 10), SortOrder = Enum.SortOrder.LayoutOrder})

        if FirstTab then
            TabBtn.ImageColor3 = Library.Theme.Accent
            Page.Visible = true
            FirstTab = false
        end

        TabBtn.MouseButton1Click:Connect(function()
            for _, t in pairs(Tabs) do
                Tween(t.Btn, {ImageColor3 = Library.Theme.TextDim})
                t.Page.Visible = false
            end
            Tween(TabBtn, {ImageColor3 = Library.Theme.Accent})
            Page.Visible = true
        end)
        
        table.insert(Tabs, {Btn = TabBtn, Page = Page})

        --// SECTION CREATION \\--
        function Tab:Section(title, side)
            local Section = {}
            local Parent = (side == "Right") and RightCol or LeftCol
            
            local SFrame = Create("Frame", {
                Parent = Parent,
                BackgroundColor3 = Library.Theme.Section,
                Size = UDim2.new(1, 0, 0, 50) -- Auto resized
            })
            Create("UICorner", {Parent = SFrame, CornerRadius = UDim.new(0, 4)})
            Create("UIStroke", {Parent = SFrame, Color = Library.Theme.Outline, Thickness = 1})

            -- Header
            local Header = Create("TextLabel", {
                Parent = SFrame,
                BackgroundColor3 = Library.Theme.Section,
                BorderSizePixel = 0,
                Position = UDim2.new(0, 10, 0, -7),
                Text = "  " .. title .. "  ",
                TextColor3 = Library.Theme.TextDim,
                TextSize = 11,
                Font = Enum.Font.GothamBold,
                AutomaticSize = Enum.AutomaticSize.X,
                Size = UDim2.new(0, 0, 0, 14)
            })

            local Container = Create("Frame", {
                Parent = SFrame,
                BackgroundTransparency = 1,
                Position = UDim2.new(0, 8, 0, 12),
                Size = UDim2.new(1, -16, 1, -16)
            })
            
            local List = Create("UIListLayout", {
                Parent = Container,
                Padding = UDim.new(0, 4),
                SortOrder = Enum.SortOrder.LayoutOrder
            })
            
            List:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
                SFrame.Size = UDim2.new(1, 0, 0, List.AbsoluteContentSize.Y + 20)
            end)

            --// ELEMENTS \\--
            
            -- TOGGLE
            function Section:Toggle(name, default, callback)
                local TFrame = Create("TextButton", {
                    Parent = Container,
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 0, 22),
                    Text = "",
                    AutoButtonColor = false
                })

                local CheckBox = Create("Frame", {
                    Parent = TFrame,
                    BackgroundColor3 = Library.Theme.Main,
                    Size = UDim2.new(0, 12, 0, 12),
                    Position = UDim2.new(0, 0, 0.5, -6)
                })
                Create("UICorner", {Parent = CheckBox, CornerRadius = UDim.new(0, 2)})
                Create("UIStroke", {Parent = CheckBox, Color = Library.Theme.Outline, Thickness = 1})

                local CheckFill = Create("Frame", {
                    Parent = CheckBox,
                    BackgroundColor3 = Library.Theme.Accent,
                    Size = UDim2.new(1, 0, 1, 0),
                    BackgroundTransparency = 1
                })
                Create("UICorner", {Parent = CheckFill, CornerRadius = UDim.new(0, 2)})

                local Label = Create("TextLabel", {
                    Parent = TFrame,
                    BackgroundTransparency = 1,
                    Position = UDim2.new(0, 20, 0, 0),
                    Size = UDim2.new(1, -50, 1, 0),
                    Text = name,
                    TextColor3 = Library.Theme.TextDim,
                    TextSize = 12,
                    Font = Enum.Font.Gotham,
                    TextXAlignment = Enum.TextXAlignment.Left
                })
                
                -- Keybind Display
                local BindBtn = Create("TextButton", {
                    Parent = TFrame,
                    BackgroundTransparency = 1,
                    Position = UDim2.new(1, -30, 0, 0),
                    Size = UDim2.new(0, 30, 1, 0),
                    Text = "[ - ]",
                    TextColor3 = Library.Theme.TextDim,
                    TextSize = 10,
                    Font = Enum.Font.Gotham
                })

                local enabled = default
                local binding = false
                local bindKey = nil

                local function SetState(state)
                    enabled = state
                    Tween(CheckFill, {BackgroundTransparency = enabled and 0 or 1})
                    Tween(Label, {TextColor3 = enabled and Library.Theme.Text or Library.Theme.TextDim})
                    callback(enabled)
                end

                if default then SetState(true) end

                TFrame.MouseButton1Click:Connect(function() SetState(not enabled) end)

                -- Bind Logic
                BindBtn.MouseButton1Click:Connect(function()
                    if not binding then
                        binding = true
                        BindBtn.Text = "..."
                        BindBtn.TextColor3 = Library.Theme.Accent
                    end
                end)

                UserInputService.InputBegan:Connect(function(input, gpe)
                    if binding and not gpe then
                        if input.KeyCode ~= Enum.KeyCode.Unknown and input.KeyCode ~= Enum.KeyCode.Escape then
                            bindKey = input.KeyCode
                            BindBtn.Text = "[ " .. input.KeyCode.Name:sub(1,3) .. " ]"
                            binding = false
                            BindBtn.TextColor3 = Library.Theme.TextDim
                        elseif input.KeyCode == Enum.KeyCode.Escape then
                            bindKey = nil
                            BindBtn.Text = "[ - ]"
                            binding = false
                            BindBtn.TextColor3 = Library.Theme.TextDim
                        end
                    elseif bindKey and input.KeyCode == bindKey and not gpe then
                        SetState(not enabled)
                        Window:Notify("Toggle", name .. (enabled and " Enabled" or " Disabled"), 1)
                    end
                end)
            end

            -- BUTTON
            function Section:Button(name, callback)
                local Btn = Create("TextButton", {
                    Parent = Container,
                    BackgroundColor3 = Library.Theme.Main,
                    Size = UDim2.new(1, 0, 0, 22),
                    Text = name,
                    TextColor3 = Library.Theme.Text,
                    TextSize = 11,
                    Font = Enum.Font.Gotham
                })
                Create("UICorner", {Parent = Btn, CornerRadius = UDim.new(0, 4)})
                Create("UIStroke", {Parent = Btn, Color = Library.Theme.Outline, Thickness = 1})

                Btn.MouseButton1Click:Connect(function()
                    Tween(Btn, {BackgroundColor3 = Library.Theme.Accent}, 0.1)
                    task.wait(0.1)
                    Tween(Btn, {BackgroundColor3 = Library.Theme.Main}, 0.2)
                    callback()
                end)
            end

            -- SLIDER
            function Section:Slider(name, min, max, default, callback)
                local SFrame = Create("Frame", {
                    Parent = Container,
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 0, 30)
                })
                
                local Label = Create("TextLabel", {
                    Parent = SFrame,
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 0, 15),
                    Text = name,
                    TextColor3 = Library.Theme.TextDim,
                    TextSize = 11,
                    Font = Enum.Font.Gotham,
                    TextXAlignment = Enum.TextXAlignment.Left
                })
                
                local Value = Create("TextLabel", {
                    Parent = SFrame,
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 0, 15),
                    Text = tostring(default),
                    TextColor3 = Library.Theme.Accent,
                    TextSize = 11,
                    Font = Enum.Font.Gotham,
                    TextXAlignment = Enum.TextXAlignment.Right
                })

                local BarBG = Create("TextButton", {
                    Parent = SFrame,
                    BackgroundColor3 = Library.Theme.Main,
                    Position = UDim2.new(0, 0, 0, 18),
                    Size = UDim2.new(1, 0, 0, 6),
                    Text = "",
                    AutoButtonColor = false
                })
                Create("UICorner", {Parent = BarBG, CornerRadius = UDim.new(1, 0)})
                Create("UIStroke", {Parent = BarBG, Color = Library.Theme.Outline, Thickness = 1})

                local BarFill = Create("Frame", {
                    Parent = BarBG,
                    BackgroundColor3 = Library.Theme.Accent,
                    Size = UDim2.new((default-min)/(max-min), 0, 1, 0),
                    BorderSizePixel = 0
                })
                Create("UICorner", {Parent = BarFill, CornerRadius = UDim.new(1, 0)})

                local dragging = false
                local function Update(input)
                    local pos = math.clamp((input.Position.X - BarBG.AbsolutePosition.X) / BarBG.AbsoluteSize.X, 0, 1)
                    Tween(BarFill, {Size = UDim2.new(pos, 0, 1, 0)}, 0.05)
                    local val = math.floor(((pos * (max - min)) + min) * 100) / 100
                    Value.Text = tostring(val)
                    callback(val)
                end

                BarBG.InputBegan:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 then
                        dragging = true; Update(input)
                    end
                end)
                UserInputService.InputChanged:Connect(function(input)
                    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then Update(input) end
                end)
                UserInputService.InputEnded:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
                end)
            end

            return Section
        end
        return Tab
    end
    
    -- Global Toggle Key
    UserInputService.InputBegan:Connect(function(input)
        if input.KeyCode == Enum.KeyCode.RightControl then
            Screen.Enabled = not Screen.Enabled
        end
    end)
    
    return Window
end

return Library
